<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ â€” Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#1976d2" />

<!-- Vazirmatn CDN (ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ A) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.min.css">

<style>
  :root{
    --bg: #f4f8fc;
    --card: #ffffff;
    --muted:#6b7785;
    --accent:#1976d2;
    --accent-600:#0f5fb0;
    --danger:#d32f2f;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: Vazirmatn, "Tahoma", sans-serif;background:var(--bg);color:#0b1a2b;-webkit-font-smoothing:antialiased}
  header{
    background: linear-gradient(90deg,var(--accent),#42a5f5);
    color:#fff;padding:18px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;
    box-shadow: 0 6px 20px rgba(25,118,210,.12);
    position: sticky; top: 0; z-index: 40;
  }
  header .title{font-size:18px;font-weight:700;margin:0}
  header .subtitle{font-size:13px;opacity:.95}
  main{max-width:980px;margin:14px auto;padding:14px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
  .btn{
    background:var(--accent);color:#fff;border:0;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer;
    box-shadow: 0 6px 14px rgba(25,118,210,.08);
  }
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,26,43,.06);box-shadow:none}
  .select, .search{
    background:var(--card);border-radius:10px;padding:6px 8px;border:1px solid #e9eef6;min-width:120px;
  }
  .search input{border:0;outline:none;padding:8px;width:220px;background:transparent;font-size:14px}
  .row{
    display:grid;grid-template-columns:1fr 280px;gap:14px;
  }

  /* card list */
  .list{display:grid;gap:12px}
  .card{
    background:var(--card);border-radius:var(--radius);padding:12px;display:flex;align-items:center;gap:12px;
    box-shadow: 0 6px 18px rgba(12,30,60,.04);
  }
  .card .left{flex:1}
  .city{font-size:16px;font-weight:700;margin-bottom:4px}
  .meta{font-size:13px;color:var(--muted)}
  .aqi{
    min-width:84px;text-align:center;border-radius:10px;padding:10px 8px;background:linear-gradient(180deg,#f6f8fb,#ffffff);
    box-shadow: inset 0 -6px 18px rgba(0,0,0,.02);
  }
  .aqi .val{font-size:20px;font-weight:800}
  .aqi .emoji{font-size:20px;margin-top:6px;display:block}

  .change{font-size:13px;color:var(--muted);margin-top:6px}

  /* right column (summary) */
  .panel{
    background:linear-gradient(180deg,#fff,#fbfdff);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(20,30,60,.04);
    height:100%;
  }
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 6px}
  .stat .label{color:var(--muted);font-size:13px}
  .stat .value{font-weight:700;font-size:15px}

  /* mobile: single column, cards full width */
  @media (max-width:900px){
    .row{grid-template-columns:1fr; }
    .controls{justify-content:space-between}
    .search input{width:140px}
  }
  @media (max-width:600px){
    .search input{width:100px}
    header .title{font-size:16px}
    .aqi{min-width:72px;padding:8px}
  }

  /* empty / loading */
  .loader{width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,.16);border-top-color:rgba(255,255,255,.9);animation:spin 0.9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* nice scrollbar for desktop */
  @media (hover:hover) {
    .list{max-height:70vh;overflow:auto;padding-right:8px}
    .list::-webkit-scrollbar{width:10px}
    .list::-webkit-scrollbar-thumb{background:rgba(11,26,43,.06);border-radius:10px}
  }
</style>
</head>
<body>
<header>
  <div>
    <div class="title">ğŸŒ Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ Ø§ÛŒØ±Ø§Ù†</div>
    <div class="subtitle">Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±: Ù‡Ø± <span id="uiInterval">60</span> Ø«Ø§Ù†ÛŒÙ‡ â€” Ù…Ù†Ø¨Ø¹: Open-Meteo</div>
  </div>

  <div id="installRow" style="display:none">
    <button class="btn" id="installBtn">Ù†ØµØ¨</button>
  </div>
</header>

<main>
  <div class="row">
    <div>
      <div class="controls">
        <div class="select">
          <select id="refresh" style="border:0;background:transparent;font-weight:700">
            <option value="60">Ø¢Ù¾Ø¯ÛŒØª: 60 Ø«Ø§Ù†ÛŒÙ‡</option>
            <option value="30">Ø¢Ù¾Ø¯ÛŒØª: 30 Ø«Ø§Ù†ÛŒÙ‡</option>
            <option value="120">Ø¢Ù¾Ø¯ÛŒØª: 120 Ø«Ø§Ù†ÛŒÙ‡</option>
          </select>
        </div>

        <div class="search">
          <input id="search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù‡Ø±..." />
        </div>

        <button class="btn ghost" id="manualRefresh">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        <button class="btn" id="sortBtn">Ù…Ø±ØªØ¨: AQI â†‘</button>
      </div>

      <div class="list card-container" id="listContainer">
        <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¯Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
      </div>
    </div>

    <aside class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Ø®Ù„Ø§ØµÙ‡ Ú©Ø´ÙˆØ±</div>
        <div style="font-size:12px;color:var(--muted)">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="lastTime">â€”</span></div>
      </div>

      <div class="stat"><div class="label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¢Ù„ÙˆØ¯Ú¯ÛŒ</div><div class="value" id="avg">â€”</div></div>
      <div class="stat"><div class="label">Ø´Ù‡Ø±Ù‡Ø§</div><div class="value" id="cityCount">â€”</div></div>
      <div style="height:8px"></div>
      <div style="color:var(--muted);font-size:13px">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Open-Meteo (Ø¨Ø¯ÙˆÙ† ØªÙˆÚ©Ù†). Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³Ø§ÛŒØª Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù¾ Ù†ØµØ¨ Ø´ÙˆØ¯.</div>

      <div style="height:12px"></div>
      <button class="btn" id="openGithub">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨</button>
    </aside>
  </div>
</main>

<footer style="text-align:center;padding:10px 0;color:var(--muted);font-size:13px">
  Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ â€” (PWA ready)
</footer>

<script>
/* ============================
   Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
   ============================ */
const cities = {
  "ØªÙ‡Ø±Ø§Ù†":[35.6892,51.3890],
  "Ù…Ø´Ù‡Ø¯":[36.2605,59.6168],
  "Ø§ØµÙÙ‡Ø§Ù†":[32.6546,51.6680],
  "Ø´ÛŒØ±Ø§Ø²":[29.5918,52.5837],
  "ØªØ¨Ø±ÛŒØ²":[38.0962,46.2738],
  "Ú©Ø±Ø¬":[35.8400,51.0000],
  "Ù‚Ù…":[34.6401,50.8764],
  "Ø§Ù‡ÙˆØ§Ø²":[31.3183,48.6706],
  "Ú©Ø±Ù…Ø§Ù†":[30.2839,57.0834],
  "ÛŒØ²Ø¯":[31.8974,54.3569],
  "Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡":[34.3142,47.0650],
  "Ø³Ù…Ù†Ø§Ù†":[35.5753,53.3958],
  "Ø±Ø´Øª":[37.2808,49.5832],
  "Ø§Ø±ÙˆÙ…ÛŒÙ‡":[37.5483,45.0672],
  "Ø§Ø±Ø¯Ø¨ÛŒÙ„":[38.2498,48.2933],
  "Ø²Ø§Ù‡Ø¯Ø§Ù†":[29.4963,60.8629],
  "Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³":[27.1865,56.2808],
  "Ú¯Ø±Ú¯Ø§Ù†":[36.8427,54.4448],
  "Ø¨ÙˆØ´Ù‡Ø±":[28.9234,50.8203],
  "Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯":[33.4878,48.3550],
  "Ù‡Ù…Ø¯Ø§Ù†":[34.8090,48.5150],
  "Ù‚Ø²ÙˆÛŒÙ†":[36.2688,50.0041],
  "Ø§Ø±Ø§Ú©":[34.0917,49.6892],
  "Ø²Ù†Ø¬Ø§Ù†":[36.6736,48.4787],
  "Ø³Ù†Ù†Ø¯Ø¬":[35.3219,46.9862],
  "Ø§ÛŒÙ„Ø§Ù…":[33.6370,46.4227],
  "Ø¨ÛŒØ±Ø¬Ù†Ø¯":[32.8649,59.2211],
  "Ú¯Ø±Ù…Ø³Ø§Ø±":[35.2369,52.3096],
  "Ù†Ø¬Ùâ€ŒØ¢Ø¨Ø§Ø¯":[32.6378,51.3536],
  "Ø´Ø§Ø¯Ú¯Ø§Ù†":[30.5841,48.2716]
};

const apiBase = "https://air-quality-api.open-meteo.com/v1/air-quality";
let refreshSec = Number(document.getElementById('refresh').value) || 60;
let timer = null;
let sortAsc = true;
let previous = {}; // Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ
const listContainer = document.getElementById('listContainer');

/* ======== helpers ======== */
function aqiEmoji(v){
  if (v===null || v===undefined) return "âŒ";
  if (v<=50) return "ğŸ™‚";
  if (v<=100) return "ğŸ˜";
  if (v<=150) return "ğŸ˜·";
  if (v<=200) return "ğŸ¤¢";
  if (v<=300) return "â˜ ï¸";
  return "ğŸ’€";
}
function aqiColor(v){
  if (v===null) return "#999";
  if (v<=50) return "#0f9d58";
  if (v<=100) return "#f4b400";
  if (v<=150) return "#ff8a00";
  if (v<=200) return "#d32f2f";
  if (v<=300) return "#7b1fa2";
  return "#5d4037";
}

/* ======== fetch one ======== */
async function fetchAQI(lat, lon){
  const url = `${apiBase}?latitude=${lat}&longitude=${lon}&hourly=us_aqi`;
  try{
    const res = await fetch(url);
    const j = await res.json();
    return j?.hourly?.us_aqi?.[0] ?? null;
  }catch(e){
    return null;
  }
}

/* ======== render card ======== */
function makeCard(name, aqi){
  const card = document.createElement('div');
  card.className = 'card';

  const left = document.createElement('div');
  left.className = 'left';

  const city = document.createElement('div');
  city.className = 'city';
  city.innerText = name;

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerText = 'Ù…Ø®ØªØµØ§Øª: ' + (cities[name] ? cities[name].join(', ') : 'â€”');

  left.appendChild(city);
  left.appendChild(meta);

  const box = document.createElement('div');
  box.className = 'aqi';
  const val = document.createElement('div');
  val.className = 'val';
  val.innerText = aqi===null ? 'Ù†Ø§Ù…Ø¹ØªØ¨Ø±' : aqi;
  val.style.color = aqiColor(aqi);

  const emoji = document.createElement('div');
  emoji.className = 'emoji';
  emoji.innerText = aqiEmoji(aqi);

  const change = document.createElement('div');
  change.className = 'change';
  const prev = previous[name];
  if (prev === undefined || prev === null) change.innerText = 'ØªØºÛŒÛŒØ±: 0';
  else {
    const d = (aqi===null || prev===null) ? 0 : (aqi - prev);
    change.innerText = 'ØªØºÛŒÛŒØ±: ' + (d>0?'+':'') + d;
  }

  box.appendChild(val);
  box.appendChild(emoji);
  box.appendChild(change);

  card.appendChild(left);
  card.appendChild(box);

  return card;
}

/* ======== main update flow ======== */
async function updateAll(){
  // stop timer
  if (timer) { clearTimeout(timer); timer = null; }

  // UI: loading placeholder
  listContainer.innerHTML = '';
  const loading = document.createElement('div');
  loading.style.display='flex';loading.style.justifyContent='center';loading.style.padding='28px';
  loading.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center"><div class="loader"></div><div style="margin-top:8px;color:var(--muted)">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...</div></div>';
  listContainer.appendChild(loading);

  const rows = [];
  for (const name of Object.keys(cities)){
    const [lat, lon] = cities[name];
    const aqi = await fetchAQI(lat, lon);
    rows.push({name, aqi});
    // small delay to be polite (avoid rapid-fire)
    await new Promise(r=>setTimeout(r, 120));
  }

  // compute average
  const vals = rows.filter(r=>r.aqi!==null).map(r=>r.aqi);
  const avg = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) : 'â€”';
  document.getElementById('avg').innerText = avg;
  document.getElementById('cityCount').innerText = rows.length;
  document.getElementById('lastTime').innerText = new Date().toLocaleTimeString('fa-IR');

  // sort
  rows.sort((a,b)=>{
    const aa = a.aqi===null?Infinity:a.aqi;
    const bb = b.aqi===null?Infinity:b.aqi;
    return sortAsc ? aa-bb : bb-aa;
  });

  // render cards
  listContainer.innerHTML = '';
  const q = document.getElementById('search').value.trim();
  for (const r of rows){
    if (q && !r.name.includes(q) && !r.name.toLowerCase().includes(q.toLowerCase())) continue;
    const card = makeCard(r.name, r.aqi);
    listContainer.appendChild(card);
    previous[r.name] = r.aqi;
  }

  // schedule next
  timer = setTimeout(updateAll, refreshSec*1000);

  // store last snapshot for offline
  try { localStorage.setItem('aqi_snapshot', JSON.stringify({time:Date.now(), rows})); } catch(e){}
}

/* ======== UI events ======== */
document.getElementById('refresh').addEventListener('change', (e)=>{
  refreshSec = Number(e.target.value);
  document.getElementById('uiInterval').innerText = refreshSec;
  if (timer){ clearTimeout(timer); timer = null; }
  updateAll();
});

document.getElementById('manualRefresh').addEventListener('click', ()=>{
  if (timer){ clearTimeout(timer); timer = null; }
  updateAll();
});

document.getElementById('sortBtn').addEventListener('click', (e)=>{
  sortAsc = !sortAsc;
  e.target.innerText = `Ù…Ø±ØªØ¨: AQI ${sortAsc ? 'â†‘' : 'â†“'}`;
  // re-render from previous snapshot
  const tmp = Object.keys(cities).map(name=>({name, aqi: previous[name] ?? null}));
  tmp.sort((a,b)=> (sortAsc ? (a.aqi===null?Infinity:a.aqi) - (b.aqi===null?Infinity:b.aqi) : (b.aqi===null?Infinity:b.aqi) - (a.aqi===null?Infinity:a.aqi)));
  listContainer.innerHTML = '';
  const q = document.getElementById('search').value.trim();
  for (const r of tmp) {
    if (q && !r.name.includes(q) && !r.name.toLowerCase().includes(q.toLowerCase())) continue;
    listContainer.appendChild(makeCard(r.name, r.aqi));
  }
});

document.getElementById('search').addEventListener('input', ()=>{
  // quick local filter
  const q = document.getElementById('search').value.trim().toLowerCase();
  const cards = listContainer.children;
  for (let i=0;i<cards.length;i++){
    const name = cards[i].querySelector('.city').innerText.toLowerCase();
    cards[i].style.display = (q && !name.includes(q)) ? 'none' : 'flex';
  }
});

document.getElementById('openGithub').addEventListener('click', ()=> {
  window.open('https://github.com/amir11ma/Gankk', '_blank');
});

/* ===== PWA install prompt ===== */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installRow').style.display = 'block';
});

document.getElementById('installBtn').addEventListener('click', async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('installRow').style.display = 'none';
});

/* ===== service worker register ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(()=>console.log('sw registered')).catch(()=>console.warn('sw failed'));
}

/* ===== on load: try load snapshot if offline, then update ===== */
window.addEventListener('load', ()=>{
  // try local snapshot
  try {
    const snap = JSON.parse(localStorage.getItem('aqi_snapshot')||'null');
    if (snap && snap.rows){
      // show cached fast UI
      document.getElementById('avg').innerText = (snap.rows.filter(r=>r.aqi!==null).map(r=>r.aqi).reduce((a,b)=>a+b,0)/snap.rows.filter(r=>r.aqi!==null).length).toFixed(1);
      document.getElementById('cityCount').innerText = snap.rows.length;
      document.getElementById('lastTime').innerText = new Date(snap.time).toLocaleTimeString('fa-IR');
      listContainer.innerHTML = '';
      for (const r of snap.rows){
        listContainer.appendChild(makeCard(r.name, r.aqi));
        previous[r.name] = r.aqi;
      }
    }
  } catch(e){}
  updateAll();
});
</script>
</body>
</html>
