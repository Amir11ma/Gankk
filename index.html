<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ Ø§ÛŒØ±Ø§Ù† (AQI) â€” ÙˆØ¨ Ø§Ù¾</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#1976d2" />

<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#666;
    --accent:#1976d2; --accent-contrast:#fff;
  }
  html,body{height:100%;margin:0;font-family: Vazirmatn, Tahoma, system-ui, sans-serif;
    background:var(--bg); color:#111; -webkit-font-smoothing:antialiased;}
  header{background:linear-gradient(90deg,#1976d2,#42a5f5); color:var(--accent-contrast);
    padding:18px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
  header h1{margin:0;font-size:18px;font-weight:700}
  header .meta{font-size:13px; opacity:.95}
  main{max-width:1100px;margin:18px auto;padding:12px;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .btn{background:var(--accent); color:var(--accent-contrast); border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,0,0,.06)}
  .search{flex:1;min-width:160px}
  input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:14px}

  /* card */
  .card{background:var(--card);box-shadow:0 6px 18px rgba(20,20,20,.06);border-radius:10px;padding:12px}

  /* table */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{background:#0b63a4;color:#fff;padding:12px 10px;text-align:center;font-weight:600}
  tbody td{padding:10px;border-bottom:1px solid #f1f1f1;text-align:center}
  .small{font-size:12px;color:var(--muted)}
  .emoji{font-size:18px}

  /* responsive: mobile layout = cards */
  @media (max-width:720px){
    thead{display:none}
    table, tbody, tr, td{display:block;width:100%}
    tr{margin-bottom:12px;border-radius:8px;overflow:hidden;background:var(--card);box-shadow:0 4px 12px rgba(0,0,0,.03)}
    td{padding:10px 12px;text-align:right}
    td::before{content:attr(data-label);float:left;font-weight:600;color:var(--muted)}
    .controls{gap:6px}
  }

  footer{max-width:1100px;margin:14px auto;color:var(--muted);font-size:13px;text-align:center;padding-bottom:20px}
  .install-row{display:flex;gap:8px;align-items:center}
  .install-prompt{background:#fff8e1;border:1px solid #ffecb3;padding:8px 10px;border-radius:8px;font-size:13px}
</style>
</head>
<body>
<header>
  <div>
    <h1>ğŸŒ Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ù‡ÙˆØ§ Ø§ÛŒØ±Ø§Ù† (AQI)</h1>
    <div class="meta small">Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±: Ù‡Ø± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ â€” Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆÚ©Ù†</div>
  </div>
  <div class="install-row" id="installRow" style="display:none">
    <div class="install-prompt">ğŸ”½ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† ÙˆØ¨â€ŒØ§Ù¾ Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯ (Add to home)</div>
    <button class="btn" id="installBtn">Ù†ØµØ¨</button>
  </div>
</header>

<main>
  <div class="card">
    <div class="controls">
      <div style="width:160px">
        <button class="btn" id="showAll">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡</button>
      </div>

      <div style="width:170px">
        <select id="refreshSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:14px">
          <option value="60">Ø¢Ù¾Ø¯ÛŒØª: 60 Ø«Ø§Ù†ÛŒÙ‡</option>
          <option value="30">Ø¢Ù¾Ø¯ÛŒØª: 30 Ø«Ø§Ù†ÛŒÙ‡</option>
          <option value="120">Ø¢Ù¾Ø¯ÛŒØª: 120 Ø«Ø§Ù†ÛŒÙ‡</option>
        </select>
      </div>

      <div class="search" style="min-width:140px">
        <input type="text" id="citySearch" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù‡Ø±..." />
      </div>

      <div style="min-width:120px">
        <button class="btn ghost" id="toggleSort">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: AQI â†‘</button>
      </div>

      <div style="min-width:140px;text-align:left">
        <div class="small">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú©Ø´ÙˆØ±ÛŒ: <span id="avgVal">â€”</span></div>
        <div class="small">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="lastUpdated">â€”</span></div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="aqiTable" class="card">
        <thead>
          <tr>
            <th>Ø´Ù‡Ø±</th>
            <th>AQI</th>
            <th>ÙˆØ¶Ø¹ÛŒØª</th>
            <th>ØªØºÛŒÛŒØ±</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
  </div>
</main>

<footer>
  Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ â€” Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡: Open-Meteo (Ø¨Ø¯ÙˆÙ† ØªÙˆÚ©Ù†). Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø¯Ø± GitHub Pages Ø§Ù…Ù† Ø§Ø³Øª.
</footer>

<script>
/* =======================
   Ù„ÛŒØ³Øª Ø´Ù‡Ø±Ù‡Ø§ (ÙØ§Ø±Ø³ÛŒ) â€” Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡/Ú©Ù… Ú©Ù†ÛŒØ¯
   Ø´Ú©Ù„: "Ù†Ø§Ù…": [lat, lon]
   ======================= */
const cities = {
  "ØªÙ‡Ø±Ø§Ù†":[35.6892,51.3890],
  "Ù…Ø´Ù‡Ø¯":[36.2605,59.6168],
  "Ø§ØµÙÙ‡Ø§Ù†":[32.6546,51.6680],
  "Ø´ÛŒØ±Ø§Ø²":[29.5918,52.5837],
  "ØªØ¨Ø±ÛŒØ²":[38.0962,46.2738],
  "Ú©Ø±Ø¬":[35.8400,51.0000],
  "Ù‚Ù…":[34.6401,50.8764],
  "Ø§Ù‡ÙˆØ§Ø²":[31.3183,48.6706],
  "Ú©Ø±Ù…Ø§Ù†":[30.2839,57.0834],
  "ÛŒØ²Ø¯":[31.8974,54.3569],
  "Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡":[34.3142,47.0650],
  "Ø³Ù…Ù†Ø§Ù†":[35.5753,53.3958],
  "Ø±Ø´Øª":[37.2808,49.5832],
  "Ø§Ø±ÙˆÙ…ÛŒÙ‡":[37.5483,45.0672],
  "Ø§Ø±Ø¯Ø¨ÛŒÙ„":[38.2498,48.2933],
  "Ø²Ø§Ù‡Ø¯Ø§Ù†":[29.4963,60.8629],
  "Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³":[27.1865,56.2808],
  "Ú¯Ø±Ú¯Ø§Ù†":[36.8427,54.4448],
  "Ø¨ÙˆØ´Ù‡Ø±":[28.9234,50.8203],
  "Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯":[33.4878,48.3550],
  "Ù‡Ù…Ø¯Ø§Ù†":[34.8090,48.5150],
  "Ù‚Ø²ÙˆÛŒÙ†":[36.2688,50.0041],
  "Ø§Ø±Ø§Ú©":[34.0917,49.6892],
  "Ø²Ù†Ø¬Ø§Ù†":[36.6736,48.4787],
  "Ø³Ù†Ù†Ø¯Ø¬":[35.3219,46.9862],
  "Ø§ÛŒÙ„Ø§Ù…":[33.6370,46.4227],
  "Ø¨ÛŒØ±Ø¬Ù†Ø¯":[32.8649,59.2211],
  "Ú¯Ø±Ù…Ø³Ø§Ø±":[35.2369,52.3096],
  "Ù†Ø¬Ùâ€ŒØ¢Ø¨Ø§Ø¯":[32.6378,51.3536],
  "Ø´Ø§Ø¯Ú¯Ø§Ù†":[30.5841,48.2716]
};

/* =========== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ =========== */
let previous = {};         // Ø°Ø®ÛŒØ±Ù‡ AQI Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø®ØªÙ„Ø§Ù
let refreshInterval = 60;  // Ø«Ø§Ù†ÛŒÙ‡
let sortAsc = true;        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ AQI ØµØ¹ÙˆØ¯ÛŒ
let updateTimer = null;
const apiBase = "https://air-quality-api.open-meteo.com/v1/air-quality";

/* ---------- helpers ---------- */
function aqiEmoji(v){
  if (v === null || v === undefined) return "âŒ";
  if (v <= 50) return "ğŸ™‚";
  if (v <= 100) return "ğŸ˜";
  if (v <= 150) return "ğŸ˜·";
  if (v <= 200) return "ğŸ¤¢";
  if (v <= 300) return "â˜ ï¸";
  return "ğŸ’€";
}
function safeNum(x){ return (x===null||x===undefined) ? null : Number(x); }

/* ---------- fetch AQI for coordinate ---------- */
async function fetchAQI(lat, lon){
  const url = `${apiBase}?latitude=${lat}&longitude=${lon}&hourly=us_aqi`;
  try{
    const res = await fetch(url);
    const j = await res.json();
    // API returns hourly.us_aqi array; first element current hour
    return j?.hourly?.us_aqi?.[0] ?? null;
  }catch(e){
    return null;
  }
}

/* ---------- build & render table ---------- */
async function updateAll(){
  // stop any running timer while updating
  if (updateTimer) { clearTimeout(updateTimer); updateTimer = null; }

  const rows = [];
  const keys = Object.keys(cities);

  // fetch sequentially to avoid floods; could be parallel but simpler and safer
  for (const name of keys){
    const [lat, lon] = cities[name];
    const aqi = await fetchAQI(lat, lon);
    rows.push({name, aqi: safeNum(aqi)});
  }

  // remove nulls for average calc
  const valid = rows.filter(r=>r.aqi!==null).map(r=>r.aqi);
  const avg = valid.length ? (valid.reduce((a,b)=>a+b,0)/valid.length).toFixed(1) : "â€”";

  document.getElementById("avgVal").innerText = avg;
  document.getElementById("lastUpdated").innerText = new Date().toLocaleTimeString('fa-IR');

  // sorting
  rows.sort((a,b)=>{
    const aa = a.aqi===null?Infinity:a.aqi;
    const bb = b.aqi===null?Infinity:b.aqi;
    return sortAsc ? aa-bb : bb-aa;
  });

  renderRows(rows);

  // schedule next update
  updateTimer = setTimeout(updateAll, refreshInterval*1000);
}

function renderRows(rows){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  const q = document.getElementById("citySearch").value.trim();
  const qLower = q ? q.toLowerCase() : "";

  for (const r of rows){
    if (qLower && !r.name.toLowerCase().includes(qLower)) continue;

    const change = (r.aqi===null) ? "" : (()=> {
      const prev = previous[r.name];
      if (prev===undefined || prev===null) return "0";
      const d = r.aqi - prev;
      return (d>0?"+":"") + d;
    })();

    // update previous only after calculating change
    previous[r.name] = r.aqi;

    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.setAttribute("data-label","Ø´Ù‡Ø±");
    tdName.innerText = r.name;

    const tdAqi = document.createElement("td");
    tdAqi.setAttribute("data-label","AQI");
    tdAqi.innerText = r.aqi===null ? "Ù†Ø§Ù…Ø¹ØªØ¨Ø±" : r.aqi;

    const tdEmoji = document.createElement("td");
    tdEmoji.setAttribute("data-label","ÙˆØ¶Ø¹ÛŒØª");
    tdEmoji.innerHTML = `<span class="emoji">${aqiEmoji(r.aqi)}</span>`;

    const tdChange = document.createElement("td");
    tdChange.setAttribute("data-label","ØªØºÛŒÛŒØ±");
    tdChange.innerText = change;

    tr.appendChild(tdName);
    tr.appendChild(tdAqi);
    tr.appendChild(tdEmoji);
    tr.appendChild(tdChange);

    tbody.appendChild(tr);
  }
}

/* ========== UI bindings ========== */
document.getElementById("citySearch").addEventListener("input", ()=> {
  // re-render from last fetched data (we don't store full rows here, so simply call updateAll to refresh)
  // but to avoid heavy API calls on typing, we can just re-render using previous values:
  // build temporary rows from cities + previous
  const tmp = Object.keys(cities).map(name=>({name, aqi: previous[name] ?? null}));
  renderRows(tmp);
});

document.getElementById("toggleSort").addEventListener("click", (e)=>{
  sortAsc = !sortAsc;
  e.target.innerText = `Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: AQI ${sortAsc ? 'â†‘' : 'â†“'}`;
  // re-render
  const tmp = Object.keys(cities).map(name=>({name, aqi: previous[name] ?? null}));
  renderRows(tmp);
});

document.getElementById("refreshSelect").addEventListener("change",(e)=>{
  refreshInterval = Number(e.target.value);
  if (updateTimer){ clearTimeout(updateTimer); updateTimer = null; }
  updateAll();
});

document.getElementById("showAll").addEventListener("click", ()=>{
  document.getElementById("citySearch").value = "";
  const tmp = Object.keys(cities).map(name=>({name, aqi: previous[name] ?? null}));
  renderRows(tmp);
});

/* ========== PWA install prompt handling ========== */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById("installRow").style.display = "flex";
});

document.getElementById("installBtn").addEventListener("click", async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById("installRow").style.display = "none";
});

/* ========== service worker registration ========== */
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=> {
    console.log('Service worker registered');
  }).catch(()=>console.warn('SW register failed'));
}

/* ========== start ========== */
updateAll();

</script>
</body>
</html>